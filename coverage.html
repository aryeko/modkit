
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>users: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/users/controller.go (100.0%)</option>
				
				<option value="file1">github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/users/module.go (83.3%)</option>
				
				<option value="file2">github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/users/repo_mysql.go (0.0%)</option>
				
				<option value="file3">github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/users/service.go (100.0%)</option>
				
				<option value="file4">github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/users/types.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package users

import (
        "encoding/json"
        "errors"
        "net/http"
        "strconv"

        "github.com/go-chi/chi/v5"
        "github.com/go-modkit/modkit/examples/hello-mysql/internal/httpapi"
        "github.com/go-modkit/modkit/examples/hello-mysql/internal/validation"
)

type Controller struct {
        service        Service
        authMiddleware func(http.Handler) http.Handler
}

func NewController(service Service, authMiddleware func(http.Handler) http.Handler) *Controller <span class="cov8" title="1">{
        return &amp;Controller{service: service, authMiddleware: authMiddleware}
}</span>

func (c *Controller) RegisterRoutes(router Router) <span class="cov8" title="1">{
        router.Handle(http.MethodGet, "/users", http.HandlerFunc(c.handleListUsers))

        router.Group("/", func(r Router) </span><span class="cov8" title="1">{
                r.Use(c.authMiddleware)
                r.Handle(http.MethodPost, "/users", http.HandlerFunc(c.handleCreateUser))
                r.Handle(http.MethodGet, "/users/{id}", http.HandlerFunc(c.handleGetUser))
                r.Handle(http.MethodPut, "/users/{id}", http.HandlerFunc(c.handleUpdateUser))
                r.Handle(http.MethodDelete, "/users/{id}", http.HandlerFunc(c.handleDeleteUser))
        }</span>)
}

// @Summary Get user
// @Description Returns a user by id.
// @Tags users
// @Produce json
// @Param id path int true "User ID"
// @Success 200 {object} User
// @Failure 400 {object} Problem
// @Failure 404 {object} Problem
// @Router /api/v1/users/{id} [get]
func (c *Controller) handleGetUser(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        idStr := chi.URLParam(r, "id")
        id, err := strconv.ParseInt(idStr, 10, 64)
        if err != nil </span><span class="cov8" title="1">{
                httpapi.WriteProblem(w, r, http.StatusBadRequest, "invalid id")
                return
        }</span>

        <span class="cov8" title="1">user, err := c.service.GetUser(r.Context(), id)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, ErrNotFound) </span><span class="cov8" title="1">{
                        httpapi.WriteProblem(w, r, http.StatusNotFound, "not found")
                        return
                }</span>
                <span class="cov8" title="1">httpapi.WriteProblem(w, r, http.StatusInternalServerError, "internal error")
                return</span>
        }

        <span class="cov8" title="1">writeJSON(w, http.StatusOK, user)</span>
}

// @Summary Create user
// @Description Creates a new user.
// @Tags users
// @Accept json
// @Produce json
// @Param body body CreateUserInput true "User payload"
// @Success 201 {object} User
// @Failure 400 {object} ProblemDetails
// @Failure 409 {object} Problem
// @Router /api/v1/users [post]
func (c *Controller) handleCreateUser(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        var input CreateUserInput
        if err := decodeJSON(r, &amp;input); err != nil </span><span class="cov8" title="1">{
                var errs validation.ValidationErrors
                errs.Add("body", "invalid")
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>
        <span class="cov8" title="1">if errs := input.Validate(); errs.HasErrors() </span><span class="cov8" title="1">{
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>

        <span class="cov8" title="1">user, err := c.service.CreateUser(r.Context(), input)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, ErrConflict) </span><span class="cov8" title="1">{
                        httpapi.WriteProblem(w, r, http.StatusConflict, "user already exists")
                        return
                }</span>
                <span class="cov8" title="1">httpapi.WriteProblem(w, r, http.StatusInternalServerError, "internal error")
                return</span>
        }
        <span class="cov8" title="1">writeJSON(w, http.StatusCreated, user)</span>
}

// @Summary List users
// @Description Returns all users.
// @Tags users
// @Produce json
// @Param page query int false "Page (&gt;= 1)"
// @Param limit query int false "Limit (&gt;= 1)"
// @Success 200 {array} User
// @Router /api/v1/users [get]
func (c *Controller) handleListUsers(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        query := r.URL.Query()
        page := 1
        limit := 20
        var errs validation.ValidationErrors
        if pageStr := query.Get("page"); pageStr != "" </span><span class="cov8" title="1">{
                parsed, err := strconv.Atoi(pageStr)
                if err != nil </span><span class="cov8" title="1">{
                        errs.Add("page", "must be a number")
                }</span> else<span class="cov8" title="1"> if parsed &lt; 1 </span><span class="cov8" title="1">{
                        errs.Add("page", "must be &gt;= 1")
                }</span> else<span class="cov8" title="1"> {
                        page = parsed
                }</span>
        }
        <span class="cov8" title="1">if limitStr := query.Get("limit"); limitStr != "" </span><span class="cov8" title="1">{
                parsed, err := strconv.Atoi(limitStr)
                if err != nil </span><span class="cov8" title="1">{
                        errs.Add("limit", "must be a number")
                }</span> else<span class="cov8" title="1"> if parsed &lt; 1 </span><span class="cov8" title="1">{
                        errs.Add("limit", "must be &gt;= 1")
                }</span> else<span class="cov8" title="1"> {
                        limit = parsed
                }</span>
        }
        <span class="cov8" title="1">if errs.HasErrors() </span><span class="cov8" title="1">{
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>

        <span class="cov8" title="1">users, err := c.service.ListUsers(r.Context())
        if err != nil </span><span class="cov8" title="1">{
                httpapi.WriteProblem(w, r, http.StatusInternalServerError, "internal error")
                return
        }</span>
        <span class="cov8" title="1">start := (page - 1) * limit
        if start &gt;= len(users) </span><span class="cov8" title="1">{
                users = []User{}
        }</span> else<span class="cov8" title="1"> {
                end := start + limit
                if end &gt; len(users) </span><span class="cov8" title="1">{
                        end = len(users)
                }</span>
                <span class="cov8" title="1">users = users[start:end]</span>
        }
        <span class="cov8" title="1">writeJSON(w, http.StatusOK, users)</span>
}

// @Summary Update user
// @Description Updates a user by id.
// @Tags users
// @Accept json
// @Produce json
// @Param id path int true "User ID"
// @Param body body UpdateUserInput true "User payload"
// @Success 200 {object} User
// @Failure 400 {object} ProblemDetails
// @Failure 404 {object} Problem
// @Router /api/v1/users/{id} [put]
func (c *Controller) handleUpdateUser(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        idStr := chi.URLParam(r, "id")
        id, err := strconv.ParseInt(idStr, 10, 64)
        if err != nil </span><span class="cov8" title="1">{
                var errs validation.ValidationErrors
                errs.Add("id", "must be a number")
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>

        <span class="cov8" title="1">var input UpdateUserInput
        if err := decodeJSON(r, &amp;input); err != nil </span><span class="cov8" title="1">{
                var errs validation.ValidationErrors
                errs.Add("body", "invalid")
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>
        <span class="cov8" title="1">if errs := input.Validate(); errs.HasErrors() </span><span class="cov8" title="1">{
                validation.WriteProblemDetails(w, r, errs)
                return
        }</span>

        <span class="cov8" title="1">user, err := c.service.UpdateUser(r.Context(), id, input)
        if err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, ErrNotFound) </span><span class="cov8" title="1">{
                        httpapi.WriteProblem(w, r, http.StatusNotFound, "not found")
                        return
                }</span>
                <span class="cov8" title="1">httpapi.WriteProblem(w, r, http.StatusInternalServerError, "internal error")
                return</span>
        }
        <span class="cov8" title="1">writeJSON(w, http.StatusOK, user)</span>
}

// @Summary Delete user
// @Description Deletes a user by id.
// @Tags users
// @Param id path int true "User ID"
// @Success 204 {object} map[string]string
// @Failure 400 {object} Problem
// @Failure 404 {object} Problem
// @Router /api/v1/users/{id} [delete]
func (c *Controller) handleDeleteUser(w http.ResponseWriter, r *http.Request) <span class="cov8" title="1">{
        idStr := chi.URLParam(r, "id")
        id, err := strconv.ParseInt(idStr, 10, 64)
        if err != nil </span><span class="cov8" title="1">{
                httpapi.WriteProblem(w, r, http.StatusBadRequest, "invalid id")
                return
        }</span>

        <span class="cov8" title="1">if err := c.service.DeleteUser(r.Context(), id); err != nil </span><span class="cov8" title="1">{
                if errors.Is(err, ErrNotFound) </span><span class="cov8" title="1">{
                        httpapi.WriteProblem(w, r, http.StatusNotFound, "not found")
                        return
                }</span>
                <span class="cov8" title="1">httpapi.WriteProblem(w, r, http.StatusInternalServerError, "internal error")
                return</span>
        }
        <span class="cov8" title="1">w.WriteHeader(http.StatusNoContent)</span>
}

func writeJSON(w http.ResponseWriter, status int, payload any) <span class="cov8" title="1">{
        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(status)
        _ = json.NewEncoder(w).Encode(payload)
}</span>

func decodeJSON(r *http.Request, target any) error <span class="cov8" title="1">{
        decoder := json.NewDecoder(r.Body)
        decoder.DisallowUnknownFields()
        return decoder.Decode(target)
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package users

import (
        "database/sql"
        "net/http"
        "time"

        "github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/auth"
        "github.com/go-modkit/modkit/examples/hello-mysql/internal/modules/database"
        "github.com/go-modkit/modkit/examples/hello-mysql/internal/platform/logging"
        "github.com/go-modkit/modkit/examples/hello-mysql/internal/sqlc"
        "github.com/go-modkit/modkit/modkit/module"
)

const (
        TokenRepository   module.Token = "users.repository"
        TokenService      module.Token = "users.service"
        TokenController   module.Token = "users.controller"
        UsersControllerID              = "UsersController"
)

type Options struct {
        Database module.Module
        Auth     module.Module
}

type Module struct {
        opts Options
}

type UsersModule = Module

func NewModule(opts Options) module.Module <span class="cov8" title="1">{
        return &amp;Module{opts: opts}
}</span>

func (m Module) Definition() module.ModuleDef <span class="cov8" title="1">{
        return module.ModuleDef{
                Name:    "users",
                Imports: []module.Module{m.opts.Database, m.opts.Auth},
                Providers: []module.ProviderDef{
                        {
                                Token: TokenRepository,
                                Build: func(r module.Resolver) (any, error) </span><span class="cov8" title="1">{
                                        db, err := module.Get[*sql.DB](r, database.TokenDB)
                                        if err != nil </span><span class="cov8" title="1">{
                                                return nil, err
                                        }</span>
                                        <span class="cov0" title="0">queries := sqlc.New(db)
                                        return NewMySQLRepo(queries), nil</span>
                                },
                        },
                        {
                                Token: TokenService,
                                Build: func(r module.Resolver) (any, error) <span class="cov8" title="1">{
                                        repo, err := module.Get[Repository](r, TokenRepository)
                                        if err != nil </span><span class="cov8" title="1">{
                                                return nil, err
                                        }</span>
                                        <span class="cov0" title="0">return NewService(repo, logging.New()), nil</span>
                                },
                        },
                },
                Controllers: []module.ControllerDef{
                        {
                                Name: UsersControllerID,
                                Build: func(r module.Resolver) (any, error) <span class="cov8" title="1">{
                                        svc, err := module.Get[Service](r, TokenService)
                                        if err != nil </span><span class="cov8" title="1">{
                                                return nil, err
                                        }</span>
                                        <span class="cov8" title="1">authMiddleware, err := module.Get[func(http.Handler) http.Handler](r, auth.TokenMiddleware)
                                        if err != nil </span><span class="cov8" title="1">{
                                                return nil, err
                                        }</span>
                                        <span class="cov8" title="1">return NewController(svc, authMiddleware), nil</span>
                                },
                        },
                },
                Exports: []module.Token{TokenService},
        }
}

// User represents the API response model.
type User struct {
        ID        int64     `json:"id"`
        Name      string    `json:"name"`
        Email     string    `json:"email"`
        CreatedAt time.Time `json:"created_at"`
        UpdatedAt time.Time `json:"updated_at"`
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package users

import (
        "context"
        "database/sql"
        "errors"

        "github.com/go-modkit/modkit/examples/hello-mysql/internal/sqlc"
        "github.com/go-sql-driver/mysql"
)

type mysqlRepo struct {
        queries *sqlc.Queries
}

func NewMySQLRepo(queries *sqlc.Queries) Repository <span class="cov0" title="0">{
        return &amp;mysqlRepo{queries: queries}
}</span>

func (r *mysqlRepo) GetUser(ctx context.Context, id int64) (User, error) <span class="cov0" title="0">{
        row, err := r.queries.GetUser(ctx, id)
        if err != nil </span><span class="cov0" title="0">{
                if errors.Is(err, sql.ErrNoRows) </span><span class="cov0" title="0">{
                        return User{}, ErrNotFound
                }</span>
                <span class="cov0" title="0">return User{}, err</span>
        }
        <span class="cov0" title="0">return User{ID: row.ID, Name: row.Name, Email: row.Email, CreatedAt: row.CreatedAt, UpdatedAt: row.UpdatedAt}, nil</span>
}

func (r *mysqlRepo) CreateUser(ctx context.Context, input CreateUserInput) (User, error) <span class="cov0" title="0">{
        result, err := r.queries.CreateUser(ctx, sqlc.CreateUserParams{Name: input.Name, Email: input.Email})
        if err != nil </span><span class="cov0" title="0">{
                var mysqlErr *mysql.MySQLError
                if errors.As(err, &amp;mysqlErr) &amp;&amp; mysqlErr.Number == 1062 </span><span class="cov0" title="0">{
                        return User{}, ErrConflict
                }</span>
                <span class="cov0" title="0">return User{}, err</span>
        }
        <span class="cov0" title="0">id, err := result.LastInsertId()
        if err != nil </span><span class="cov0" title="0">{
                return User{}, err
        }</span>
        <span class="cov0" title="0">return r.GetUser(ctx, id)</span>
}

func (r *mysqlRepo) ListUsers(ctx context.Context) ([]User, error) <span class="cov0" title="0">{
        rows, err := r.queries.ListUsers(ctx)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">users := make([]User, 0, len(rows))
        for _, row := range rows </span><span class="cov0" title="0">{
                users = append(users, User{ID: row.ID, Name: row.Name, Email: row.Email, CreatedAt: row.CreatedAt, UpdatedAt: row.UpdatedAt})
        }</span>
        <span class="cov0" title="0">return users, nil</span>
}

func (r *mysqlRepo) UpdateUser(ctx context.Context, id int64, input UpdateUserInput) (User, error) <span class="cov0" title="0">{
        result, err := r.queries.UpdateUser(ctx, sqlc.UpdateUserParams{ID: id, Name: input.Name, Email: input.Email})
        if err != nil </span><span class="cov0" title="0">{
                return User{}, err
        }</span>
        <span class="cov0" title="0">affected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return User{}, err
        }</span>
        <span class="cov0" title="0">if affected == 0 </span><span class="cov0" title="0">{
                return User{}, ErrNotFound
        }</span>
        <span class="cov0" title="0">return r.GetUser(ctx, id)</span>
}

func (r *mysqlRepo) DeleteUser(ctx context.Context, id int64) error <span class="cov0" title="0">{
        result, err := r.queries.DeleteUser(ctx, id)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">affected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov0" title="0">if affected == 0 </span><span class="cov0" title="0">{
                return ErrNotFound
        }</span>
        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package users

import (
        "context"
        "log/slog"
        "time"

        modkitlogging "github.com/go-modkit/modkit/modkit/logging"
)

type Service interface {
        GetUser(ctx context.Context, id int64) (User, error)
        CreateUser(ctx context.Context, input CreateUserInput) (User, error)
        ListUsers(ctx context.Context) ([]User, error)
        UpdateUser(ctx context.Context, id int64, input UpdateUserInput) (User, error)
        DeleteUser(ctx context.Context, id int64) error
        LongOperation(ctx context.Context) error
}

type service struct {
        repo               Repository
        logger             modkitlogging.Logger
        longOperationDelay time.Duration
}

func NewService(repo Repository, logger modkitlogging.Logger) Service <span class="cov8" title="1">{
        if logger == nil </span><span class="cov8" title="1">{
                logger = modkitlogging.NewNopLogger()
        }</span>
        <span class="cov8" title="1">logger = logger.With(slog.String("scope", "users"))
        return &amp;service{
                repo:               repo,
                logger:             logger,
                longOperationDelay: 2 * time.Second,
        }</span>
}

func (s *service) GetUser(ctx context.Context, id int64) (User, error) <span class="cov8" title="1">{
        s.logger.Debug("get user", slog.Int64("id", id))
        return s.repo.GetUser(ctx, id)
}</span>

func (s *service) CreateUser(ctx context.Context, input CreateUserInput) (User, error) <span class="cov8" title="1">{
        s.logger.Debug("create user", slog.String("email", input.Email))
        return s.repo.CreateUser(ctx, input)
}</span>

func (s *service) ListUsers(ctx context.Context) ([]User, error) <span class="cov8" title="1">{
        s.logger.Debug("list users")
        return s.repo.ListUsers(ctx)
}</span>

func (s *service) UpdateUser(ctx context.Context, id int64, input UpdateUserInput) (User, error) <span class="cov8" title="1">{
        s.logger.Debug("update user", slog.Int64("id", id))
        return s.repo.UpdateUser(ctx, id, input)
}</span>

func (s *service) DeleteUser(ctx context.Context, id int64) error <span class="cov8" title="1">{
        s.logger.Debug("delete user", slog.Int64("id", id))
        return s.repo.DeleteUser(ctx, id)
}</span>

func (s *service) LongOperation(ctx context.Context) error <span class="cov8" title="1">{
        s.logger.Debug("long operation")
        select </span>{
        case &lt;-ctx.Done():<span class="cov8" title="1">
                return ctx.Err()</span>
        case &lt;-time.After(s.longOperationDelay):<span class="cov8" title="1">
                return nil</span>
        }
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package users

import (
        "strings"

        "github.com/go-modkit/modkit/examples/hello-mysql/internal/validation"
)

type CreateUserInput struct {
        Name  string `json:"name"`
        Email string `json:"email"`
}

func (i CreateUserInput) Validate() validation.ValidationErrors <span class="cov8" title="1">{
        var errs validation.ValidationErrors
        if strings.TrimSpace(i.Name) == "" </span><span class="cov8" title="1">{
                errs.Add("name", "is required")
        }</span>
        <span class="cov8" title="1">if strings.TrimSpace(i.Email) == "" </span><span class="cov8" title="1">{
                errs.Add("email", "is required")
        }</span>
        <span class="cov8" title="1">return errs</span>
}

type UpdateUserInput struct {
        Name  string `json:"name"`
        Email string `json:"email"`
}

func (i UpdateUserInput) Validate() validation.ValidationErrors <span class="cov8" title="1">{
        var errs validation.ValidationErrors
        if strings.TrimSpace(i.Name) == "" </span><span class="cov8" title="1">{
                errs.Add("name", "is required")
        }</span>
        <span class="cov8" title="1">if strings.TrimSpace(i.Email) == "" </span><span class="cov8" title="1">{
                errs.Add("email", "is required")
        }</span>
        <span class="cov8" title="1">return errs</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
